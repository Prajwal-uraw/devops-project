pipeline {
    agent any

    environment {
        // Docker Compose file path
        COMPOSE_FILE = 'docker-compose.yml'
    }

    stages {
        stage('Checkout') {
            steps {
                // Pull the code from your GitHub repo
                git branch: 'main', url: 'https://github.com/Prajwal-uraw/devops-project.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo 'Building Docker images for service1 and service2...'
                // Build using docker-compose
                sh "docker-compose build"
            }
        }

        stage('Run Services') {
            steps {
                echo 'Starting services...'
                sh "docker-compose up -d"
            }
        }

        stage('Test Services') {
            steps {
                echo 'Running basic tests...'
                // Optional: you can add curl or Python requests to test endpoints
                sh "curl -f http://localhost:5000 || echo 'Service1 failed'"
                sh "curl -f http://localhost:5001 || echo 'Service2 failed'"
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            // Stop containers after build
            sh "docker-compose down"
        }
        success {
            echo 'Pipeline finished successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs.'
        }
    }
}
